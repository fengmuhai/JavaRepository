项目总结
=====================

一、短信平台项目 - 易联
---------------------
**1.支付平台的请求短信发送两次的问题**

**问题描述**：更新项目后发现，每个订单都发送了两条短信。记录显示，dna平台先向旧通道梦网发了条短信，再向短信平台发一条。

**问题片排查**：通过查看短信平台的日志发现了问题，dna平台发到短信平台的请求要过20多秒才收到，日了狗...那dna平台肯定超时啊，所以dna又向旧通道发了一条。 
20多秒后，SMS接受到dna请求后又发送了短信，发两条短信的原因由此而来。

**bug分析**： 

1）先不管平台为什么延时那么久才收到。首先，SMS平台的健壮性就有问题：为什么不判断对方发过来的请求的交易时间。超时那么久还要发？ 

2）生产上的机器间延时，如1.16、1.11到1.7延时20多秒

**解决办法**： 

1）对于第一个问题，拿报文的transdatetime和接收时间比较，设置超时判断。超时时间比dna平台少1s； 

2）后来测试定位到问题出在了request.getRemoteHost()这一行，执行耗时将近20秒。网上查到相关资料是getRemoteHost()方法有性能的问题：https://blog.csdn.net/eleven204/article/details/6625701 ，后来改成request.getRemoteAddr()问题得到解决。


二、真易支付平台风控 - 真易
------------------------
**1.解决风控回退的问题 - 数据一致性的例子**

**问题描述**

1)某些风控规则需要在订单失败的时候回退：用户代付单卡单日限额风控、商户代付单日限额风控、代付组限额风控，称这写为RAB（Risk And BackRisk）类分控；

2)当订单已通过RAB类风控，但被后续风控拦截，由于直接作废了订单，未执行AgentPayCmpt.payFinal()，无法减掉失败订单的金额，导致记录的风控金额与订单实际交易金额有一定的误差；

注：payFinal()是支付流程完成后，对订单、交易等状态进行最后的更新和确认的方法。


**总结就是**：增加了风控金额总额后，一些代码直接作废了订单，未执行减少的方法，没有减掉风控总额，出现了误差。（由于之前订单流程未完全考虑风控失败引发的问题，导致风控代码设计合理性欠佳，意料之中的）

**解决方法**

1）将风控回退放在this.preCommit()方法之后，因为此方法是提交前的最后判断，向渠道发起代付前的失败都会在这里之前判断。

2）系统内失败的订单回退 与 异步失败的回退 不一样，只需要回退已执行且通过的风控（未通过的风控，若需要回退应该直接回退）。所以RiskService需要增加systemBackawordRisk()方法：forwardRisk()中记录已执行的Risk，回退时systemBackawordRisk()回退已执行且通过风控。

**总结就是**：1）将风控调整到最后的流程，保证在此流程之后订单失败的问题都能在payFinal()得到处理；2）增加风控执行记录表，对已执行的风控进行回退。



2.其他数据一致性问题
--------------------
1）增减金额数据时，使用redis的incr()方法，保证总额的一致性。


